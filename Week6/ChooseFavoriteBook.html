<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button
      title="Click to submit your ratings once you have selected one book in each pairing."
      id="submit"
      onclick="createBoxes()"
      onmouseover="checkIfReadyToSubmit()"
      onmouseout="this.style.background = ''"
    >
      Click to Submit Rankings
    </button>
    <script src="./myBooks.js"></script>
    <script>
      let heightOfEachBox = 0;
      let totalNumberOfBooksWithARatingOfFive = 0;
      let exponentOfTwo = 0;
      let numberOfBooks = 0;
      let readyToSubmit = true;
      let titlesOfBooksWithRatingsOfFive = [];
      const bracketWidth = 1350;
      const bracketHeight = 500;
      const arrayOfBooksIHaveRead = myBooks.haveRead;
      const arrayWithByes = [];

      const addImages = () => { // new
        for (let i = 0; i < arrayOfBooksIHaveRead.length; i++) {
            arrayOfBooksIHaveRead[i].push("https://upload.wikimedia.org/wikipedia/en/3/39/The_Hunger_Games_cover.jpg")
        }
      }
      addImages(); // new 
      

      const createArrayOfBooksIRatedAFive = () => {
        const filteredByRatingOfFive = arrayOfBooksIHaveRead.filter(
          (item) => item[2] === 5
        );
        titlesOfBooksWithRatingsOfFive = filteredByRatingOfFive.map(
          (item) => item[5]
        );
        totalNumberOfBooksWithARatingOfFive =
          titlesOfBooksWithRatingsOfFive.length;
        exponentOfTwo = Math.ceil(
          Math.log2(totalNumberOfBooksWithARatingOfFive)
        );
        numberOfByes = 2 ** exponentOfTwo % totalNumberOfBooksWithARatingOfFive;
        for (let i = 0; i < 2 * numberOfByes; i += 2) {
          titlesOfBooksWithRatingsOfFive.splice(i, 0, "https://en.wikipedia.org/wiki/File:ByeByeBirdie1.jpg"); //changed
        }

        numberOfBooks = totalNumberOfBooksWithARatingOfFive; //
      };

      const createBoxes = () => {
        if (readyToSubmit) {
          let currentArrayOfTitles = updateCurrentArrayOfTitles(); // build this
          exponentOfTwo = Math.ceil(Math.log2(numberOfBooks));
          let horizontalSpacing = calculateHorizontalSpacing(exponentOfTwo);
          for (let i = 0; i < 2 ** exponentOfTwo; i++) {
            let box = document.createElement("div");
            box.style.position = "absolute";
            box.style.zIndex = 1;
            box.style.backgroundColor = "rgb(218,210,210)";
            box.style.borderStyle = "solid";
            box.style.borderColor = "black;";
            box.style.width = horizontalSpacing + "px";
            box.style.height = heightOfEachBox + "px";
            box.style.left = horizontalSpacing * (2 * i + 1) + "px";
            box.style.top = heightOfEachBox * (3 * exponentOfTwo + 1) + "px";
            box.style.display = "flex";
            box.style.justifyContent = "center";
            box.style.alignItems = "center";
            box.innerHTML = currentArrayOfTitles[i];
            console.log(currentArrayOfTitles[i]);
            if (exponentOfTwo === 0 && i === 0) {
              box.setAttribute("id", "winner");
              box.setAttribute("onclick", `update('winner')`);
              box.style.backgroundColor = "steelblue";
            } else {
              box.setAttribute("id", `${exponentOfTwo}` + `${i}`);
              box.setAttribute("onclick", `update(${exponentOfTwo}` + `${i})`);
            }
            document.body.appendChild(box);
          }
          numberOfBooks = 2 ** (exponentOfTwo - 1);
          readyToSubmit = false;
        }
      };
      const calculateHorizontalSpacing = (exponentOfTwo) => {
        return bracketWidth / (2 ** (exponentOfTwo + 1) + 1);
      };

      const calculateVerticalSpacing = (
        totalNumberOfBooksWithARatingOfFive
      ) => {
        let highestExponentOfTwo = Math.ceil(
          Math.log2(totalNumberOfBooksWithARatingOfFive)
        );
        heightOfEachBox =
          bracketHeight /
          (highestExponentOfTwo + 2 * (highestExponentOfTwo - 1));
      };

      const checkIfReadyToSubmit = () => {
        let numberOfGreenBooksInCurrentRound = 0;
        for (let i = 0; i < 2 ** exponentOfTwo; i++) {
          let id = "" + exponentOfTwo + i;

          if (
            document.getElementById(id).style.backgroundColor === "lightblue"
          ) {
            numberOfGreenBooksInCurrentRound++;
          }
        }
        if (numberOfGreenBooksInCurrentRound === 2 ** exponentOfTwo / 2) {
          readyToSubmit = true;
        }
        if (readyToSubmit) {
          document.getElementById("submit").style.backgroundColor =
            "darkseagreen";
        } else {
          document.getElementById("submit").style.backgroundColor = "tomato";
        }
      };

      const update = (id) => {
        let idString = id.toString();
        if (idString.charAt(0) === exponentOfTwo.toString()) {
          //ensuring you can't go back and change selections from an earlier round
          if (
            id !== "winner" &&
            document.getElementById(id).innerHTML !== "bye"
          ) {
            document.getElementById(id).style.backgroundColor = "lightblue";
            if (id % 2 === 0) {
              document.getElementById(id + 1).style.backgroundColor =
                "rgb(218,210,210)";
            } else {
              document.getElementById(id - 1).style.backgroundColor =
                "rgb(218,210,210)";
            }
          }
        }
      };

    

      const updateCurrentArrayOfTitles = () => {
        if (numberOfBooks === totalNumberOfBooksWithARatingOfFive) {
            let arrayOfInnerHTMLForImages = [];
            for (let i = 0; i < titlesOfBooksWithRatingsOfFive.length; i ++) {
                arrayOfInnerHTMLForImages.push(`<img src = "${titlesOfBooksWithRatingsOfFive[i]}" height = "${heightOfEachBox}">`);
            }
         
            return arrayOfInnerHTMLForImages;
          
        } else {
          let currentArrayOfTitles = [];
          for (let i = 0; i < 2 ** exponentOfTwo; i++) {
            if (
              document.getElementById(`${exponentOfTwo}` + `${i}`).style
                .backgroundColor === "lightblue"
            ) {
              currentArrayOfTitles.push(
                document.getElementById(`${exponentOfTwo}` + `${i}`).innerHTML
              );
             
            }
          }
          return currentArrayOfTitles;
        }
      };

      createArrayOfBooksIRatedAFive();
      calculateVerticalSpacing(totalNumberOfBooksWithARatingOfFive);
      createBoxes();
    </script>
  </body>
</html>
